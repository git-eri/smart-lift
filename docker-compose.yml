
services:
  traefik:
    image: traefik:v3.4
    container_name: traefik
    restart: unless-stopped
    command:
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --api.insecure=${TRAEFIK_API_INSECURE:-false}
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      # Beide EntryPoints sind immer da; ob TLS verwendet wird, entscheidet das Overlay
      - --entryPoints.web.address=:80
      - --entryPoints.websecure.address=:443
      # Optional: Dateiproducer für Self-Signed (im LE-Overlay unkritisch, im Self-Overlay genutzt)
      - --providers.file.directory=/dynamic
      - --providers.file.watch=true
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/dynamic:/dynamic   # bleibt leer, außer im Self-Signed-Modus
    # ACME-Storage & Zertifikate werden nur in den jeweiligen Overlays gemountet

  frontend:
    build: { context: ./frontend }
    image: smart-lift-frontend
    container_name: frontend
    restart: unless-stopped
    labels:
      - traefik.enable=true
      # --- FRONTEND: Domain + HTTPS ---
      - traefik.http.routers.frontend-web.rule=Host(`${HOSTNAME:-localhost}`) && !PathPrefix(`/api`)
      - traefik.http.routers.frontend-web.entrypoints=web
      - traefik.http.routers.frontend-web.priority=10
      - traefik.http.services.frontend.loadbalancer.server.port=80
      - traefik.http.routers.frontend-websecure.rule=Host(`${HOSTNAME:-localhost}`) && !PathPrefix(`/api`)
      - traefik.http.routers.frontend-websecure.entrypoints=websecure
      - traefik.http.routers.frontend-websecure.tls=true
      - traefik.http.routers.frontend-websecure.priority=10
      # --- FRONTEND: LAN / IP fallback ---
      - traefik.http.routers.frontend-any.rule=PathPrefix(`/`) && !PathPrefix(`/api`)
      - traefik.http.routers.frontend-any.entrypoints=web
      - traefik.http.routers.frontend-any.priority=1

  backend:
    build: { context: ./backend }
    image: smart-lift-backend
    container_name: backend
    restart: unless-stopped
    volumes:
      - ./binaries:/code/app/binaries
      - ./lift_info.json:/code/app/lift_info.json
    labels:
      - traefik.enable=true
      # --- BACKEND: Domain + HTTP ---
      - traefik.http.routers.backend-web.rule=Host(`${HOSTNAME:-localhost}`) && PathPrefix(`/api`)
      - traefik.http.routers.backend-web.entrypoints=web
      - traefik.http.routers.backend-web.middlewares=api-strip
      - traefik.http.routers.backend-web.priority=60
      - traefik.http.services.backend.loadbalancer.server.port=8000
      # --- BACKEND: Domain + HTTPS ---
      - traefik.http.routers.backend-websecure.rule=Host(`${HOSTNAME:-localhost}`) && PathPrefix(`/api`)
      - traefik.http.routers.backend-websecure.entrypoints=websecure
      - traefik.http.routers.backend-websecure.tls=true
      - traefik.http.routers.backend-websecure.middlewares=api-strip
      - traefik.http.routers.backend-websecure.priority=60
      # --- BACKEND: LAN/IP fallback ---
      - traefik.http.routers.backend-any.rule=PathPrefix(`/api`)
      - traefik.http.routers.backend-any.entrypoints=web
      - traefik.http.routers.backend-any.middlewares=api-strip
      - traefik.http.routers.backend-any.priority=50
      # Strip /api prefix
      - traefik.http.middlewares.api-strip.stripprefix.prefixes=/api
